parameters:
- name: repo
  type: string
- name: scriptEnvVariables
  type: string
- name: expectedCredentialProviderVersion
  type: string

steps:
- checkout: ${{ parameters.repo }}
- task: PipAuthenticate@1
  displayName: 'Pip authenticate'
  inputs:
    artifactFeeds: 'PipelineTools/artifacts-credprovider'
- script: pip install build
  displayName: 'Install dependencies'
- bash: |
    ${{ parameters.scriptEnvVariables }}
    python -m build --outdir $(Build.ArtifactStagingDirectory)/Keyring >> ./output.log
    
    echo "Output log:"
    echo "------------------"
    cat ./output.log
    echo "------------------"

    if ! grep ${{ parameters.expectedCredentialProviderVersion }} ./output.log; then
      echo "Expected credential provider not found"
      exit 1
    fi

    echo "Checking for Credential Provider installation..."

    if [ ! -d "./src/artifacts_keyring/plugins/plugins/netcore/CredentialProvider.Microsoft" ]; then
      echo "Credential provider plugin directory not found"
      exit 1
    fi
    
    echo "Credential provider installed successfully"
  workingDirectory: $(Build.SourcesDirectory)
  displayName: Validate Install Script
- script: mkdir KeyringValidation
  workingDirectory: '$(Build.ArtifactStagingDirectory)'
  displayName: Prep Validation Folder
- script: |
    pip install --find-links=$(Build.ArtifactStagingDirectory)/Keyring artifacts_keyring --force-reinstall
    pip install setuptools --force-reinstall --index-url https://pkgs.dev.azure.com/mseng/_packaging/Python/pypi/simple/
  workingDirectory: '$(Build.ArtifactStagingDirectory)/KeyringValidation'
  displayName: Validate Keyring Build